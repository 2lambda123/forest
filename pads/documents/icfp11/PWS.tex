\begin{code}
\mkred{\{-# LANGUAGE TypeSynonymInstances, TemplateHaskell, QuasiQuotes,
    MultiParamTypeClasses, FlexibleInstances, DeriveDataTypeable,
    ScopedTypeVariables #-\}} 
\mbox{}
\kw{module} Examples.PWS \kw{where}
\kw{import} Language.Pads.Padsc
\kw{import} Language.Forest.Forestc \kw{hiding} (sources)
\kw{import} System.IO.Unsafe (unsafePerformIO)
\kw{import} Language.Pads.GenPretty
\kw{import} Language.Forest.Graph
\mbox{}
[pads| 
  \mkred{-- Configuration file for learning demo web site; contains paths to various web site components.}
  \kw{data} Config_f =  Config_f \{
                      header      :: [Line StringLn] \kw{length} 13,
   "$host_name   =",  host_name   :: Config_entry_t,  \mkred{-- Name of machine hosting web site}
   "$static_path =",  static_path :: Config_entry_t,  \mkred{-- URL prefix for static content}
   "$cgi_path    =",  cgi_path    :: Config_entry_t,  \mkred{-- URL prefix for cgi content}
   "$script_path =",  script_path :: Config_entry_t,  \mkred{-- Path to directory of scripts in live web site}
   "$tmp_root    =",  tmp_root    :: Config_entry_t,  \mkred{-- Path to directory for demo user data}
   "$pads_home   =",  pads_home   :: Config_entry_t,  \mkred{-- Path to directory containing pads system}
   "$learn_home  =",  learn_home  :: Config_entry_t,  \mkred{-- Path to directory containing learning system}
   "$sml_home    =",  sml_home    :: Config_entry_t,  \mkred{-- Path to directory containing SML executable}
   "$install_src =",  install_src :: Config_entry_t,  \mkred{-- Path to directory containing learning demo website source}
   "$static_dst  =",  static_dst  :: Config_entry_t,  \mkred{-- Path to directory for static content in live web site}
   "$cgi_dst     =",  cgi_dst     :: Config_entry_t,  \mkred{-- Path to directory for cgi content in live web site site}
                      trailer     :: [Line StringLn]
   \}
\mbox{}
  \kw{type} Config_entry_t = Line (" \\"",  StringC '\\"',  "\\";")   
\mbox{}
  \kw{newtype} Header_t = Header_t ([Line StringLn] \kw{length} 13)
\mbox{}
  \mkred{\{- Fle listing data sources for web site -\}}
  \kw{newtype} SourceNames_f = SourceNames_f [Line StringLn]
\mbox{}
  \mkred{\{- Information related to a single user's use of the web site -\}}
  \kw{newtype} UserEntries_f = UserEntries_f ([Line UserEntry_t] \kw{terminator} EOR)
\mbox{}
  \mkred{\{- Each visitor gets assigned a userId that is passed as a ? parameter in URL.
     Security considerations preclude using user-modifiable values as part of file paths.
     Thus, we map each userId to a corresponding dirId.
     The dirId names the directory containing the associated user's data. 
     A userEntry_t contains a single such mapping.
     A file with type userEntries_t describes a collection of such mappings.
  -\}}
  \kw{data} UserEntry_t =  UserEntry_t \{
     "id.",   usrId :: Int,               
    ",id.",   dirId :: (Int, '.', Int)    \kw{where} <| usrId == fst dirId |> 
  \} 
\mbox{}
  \mkred{\{- Log of requests.  Used to prevent denial of service attacks. -\}}
  \kw{newtype} LogFile_f = LogFile_f [Line LogEntry_t]
\mbox{}
\end{code}

\begin{code}

  \mkred{\{- Request entry.  -\}}
  \kw{data} LogEntry_t = LogEntry_t \{
    userId :: Int,         ',',   \mkred{-- user making request}
    ip     :: IP_t,        ',',   \mkred{-- IP address of requestor}
    script :: StringC ' ', ' ',   \mkred{-- script to be executed}
    userDir:: StringC ' ', ' ',   \mkred{-- directory to put results, corresponds to user}
    padsv  :: StringC ' ', ' ',   \mkred{-- version of PADS used}
    sml    :: StringSE '[ ]',     \mkred{-- version of SML used}
    msg    :: Maybe StringLn      \mkred{-- optional message}
  \}
\mbox{}
  \kw{type} IP_t = (Int, '.', Int, '.', Int, '.', Int)
|]
\end{code}

\begin{code}


\mbox{}
[forest|
  \mkred{\{- Files with various permission settings. -\}}
  \kw{type} BinaryRO    = BinaryFile    \kw{where} <| get_modes this_att ==  "-rw-r--r--" |>
  \kw{type} BinaryRX    = BinaryFile    \kw{where} <| get_modes this_att ==  "-rwxr-xr-x" |>
  \kw{type} TextRX      = TextFile      \kw{where} <| get_modes this_att ==  "-rwxr-xr-x" |>
  \kw{type} TextRO      = TextFile      \kw{where} <| get_modes this_att ==  "-rw-r--r--" |>
\mbox{}  
  \mkred{\{- Optional binary file with read/execute permission. -\}}
  \kw{type} OptBinaryRX = Maybe BinaryRX
\mbox{}
  \mkred{\{- Files with PADS descriptions -\}}
  \kw{type} Config      = File Config_f      \kw{where} <| get_modes this_att ==  "-rw-r--r--" |>
  \kw{type} SourceNames = File SourceNames_f \kw{where} <| isReadOnly this_att |>
  \kw{type} UserEntries = File UserEntries_f \kw{where} <| isReadOnly this_att |>
  \kw{type} LogFile     = File LogFile_f     \kw{where} <| isReadOnly this_att |>
\mbox{}
  \mkred{\{- Directory of image files -\}}
  \kw{type} Imgs_d = \kw{Directory} \{
    logo     \kw{is} "pads_small.jpg" :: BinaryRO,
    favicon  \kw{is} "favicon.ico"    :: BinaryRO
  \}
\mbox{}
  \mkred{\{- Directory of static content -\}}
  \kw{type} Static_d = \kw{Directory} \{
    style_sheet \kw{is} "pads.css"           :: TextRO,   
    intro_redir \kw{is} "learning-demo.html" :: TextRO,   
    title_frame \kw{is} "atitle.html"        :: TextRO,   
    logo_frame  \kw{is} "top-left.html"      :: TextRO,   
    top_frame   \kw{is} "banner.html"        :: TextRO,   
    empty_frame \kw{is} "nothing.html"       :: TextRO,
    images      \kw{is} "images"             :: Imgs_d \kw{where} <| get_modes images_md == "drwxr-xr-x" |>
  \}
\mbox{}
\mkred{\{- Directory of dynamic content -\}}
  \kw{type} Cgi_d = \kw{Directory} \{
    config'       \kw{is} "PLConfig.pm"             :: TextRO,   
    perl_utils    \kw{is} "PLUtilities.pm"          :: TextRO,     
    intro         \kw{is} "learning-demo.cgi"       :: TextRX,     
    intro_nav     \kw{is} "navbar-orig.cgi"         :: TextRX,     
    select_data   \kw{is} "pads.cgi"                :: TextRX,     
    result_nav    \kw{is} "navbar.cgi"              :: TextRX,     
    format_chosen \kw{is} "data-results.cgi"        :: TextRX,     
    gen_desc      \kw{is} "build-description.cgi"   :: TextRX,     
    get_user_data \kw{is} "build-roll-your-own.cgi" :: TextRX,     
    gen_desc_usr  \kw{is} "genData.cgi"             :: TextRX,     
    build_lib     \kw{is} "build-library.cgi"       :: TextRX,     
    build_accum   \kw{is} "build-accum.cgi"         :: TextRX,     
    build_xml     \kw{is} "build-xml.cgi"           :: TextRX,     
    build_fmt     \kw{is} "build-fmt.cgi"           :: TextRX     
  \}

\end{code}

\begin{code}
\mkred{\{- Directory of shell scripts invoked by CGI to run learning system -\}}
 \kw{type} Scripts_d = \kw{Directory} \{
    rlearn                    :: TextRX,    \mkred{-- Shell script for running PADS comiler on stock format}
    rlearnown \kw{is} "rlearn-own" :: TextRX,    \mkred{-- Shell script for running PADS compiler on user format}
    raccum    \kw{is} "r-accum"    :: TextRX,    \mkred{-- Shell script to generate and run accumulator}
    rxml      \kw{is} "r-xml"      :: TextRX,    \mkred{-- Shell script to generate and run XML converter}
    rfmt      \kw{is} "r-fmt"      :: TextRX,    \mkred{-- Shell script to generate and run formating program}
    rlibrary                  :: TextRX     \mkred{-- Shell script to build PADS library}
  \}
\mbox{}
\mkred{\{- Directory containing administrative files used by demo web site -\}}
 \kw{type} Info_d = \kw{Directory} \{
     sources \kw{is} "sampleFiles" :: SourceNames,  \mkred{-- List of source data files whose formats can be learned}
     users   \kw{is} "userFile"    :: UserEntries,  \mkred{-- Mapping from userIDs to associated directory names}
     logFile \kw{is} "logFile"     :: LogFile       \mkred{-- Log of server actions.}
  \}                          
\mbox{}
\mkred{\{- Collection of files named by sources containing actual data.  -\}}
 \kw{type} DataSource_d(sources :: [String]) =  [ s :: TextFile | s <- sources ]
\mbox{}
\mkred{\{- Type of a symbolic link with pointing to source-\}}
 \kw{type} SymLink_f (path :: FilePath) = SymLink \kw{where} <| this == path |>
\mbox{}
\mkred{\{- Directory of optional links to source data files -\}}
 \kw{type} Data_d ((root,sources) :: (FilePath, [String])) = \kw{Directory} {
     datareps  \kw{is} [s :: Maybe TextFile                        | s <- sources],
     datalinks \kw{is} [s :: Maybe (SymLink_f <| root++"/"++ s |>) | s <- sources]        
 }
\mbox{}
\mkred{\{- Directory that stores the generated machine-dependent output for data source named source -\}}
 \kw{type} MachineDep_d (source :: String) = \kw{Directory} \{
   pads_c    \kw{is} <| source ++ ".c"    |> :: TextRO,      \mkred{-- Generated C source for PADS description}
   pads_h    \kw{is} <| source ++ ".h"    |> :: TextRO,      \mkred{-- Generated C header for PADS description}
   pads_o    \kw{is} <| source ++ ".o"    |> :: BinaryRO,    \mkred{-- Compiled library for PADS description}
   pads_pxml \kw{is} <| source ++ ".pxml" |> :: TextRO,      \mkred{-- PADS description in xml syntax}
   pads_xsd  \kw{is} <| source ++ ".xsd"  |> :: TextRO,      \mkred{-- Xschema of XML syntax for source description}
   pads_acc  \kw{is} <| source ++ "-accum"|> :: OptBinaryRX, \mkred{-- Optional generated accumulator program}
   pads_fmt  \kw{is} <| source ++ "-fmt"  |> :: OptBinaryRX, \mkred{-- Optional generated formatting program}
   pads_xml  \kw{is} <| source ++ "-xml"  |> :: OptBinaryRX  \mkred{-- Optional generated XML conversion program}
 \}

\mbox{}
\mkred{\{- Directory that stores the generated output for data source named "source". -\}}
 \kw{type} Example_d (source :: String) = \kw{Directory} \{
   pads_p         \kw{is} <| source ++ ".p" |>            :: TextRO,         \mkred{-- PADS/C description of data source}
   pads_pml       \kw{is} <| source ++ ".pml" |>          :: Maybe TextRO,   \mkred{-- PADS/ML description of data source}
   vanilla        \kw{is} "vanilla.p"                     :: TextRO,         \mkred{-- input tokenization}
   makefile       \kw{is} "GNUmakefile"                   :: TextFile,       \mkred{-- Makefile}
   machine        \kw{is} <| envVar "AST_ARCH"|>          :: Maybe (MachineDep_d source),   \mkred{-- Platform dependent files}
   accum_c        \kw{is} <| source ++ "-accum.c" |>      :: Maybe TextRO,   \mkred{-- Template for accumulator program}
   accum_out      \kw{is} <| source ++ "-accum.out"|>     :: Maybe TextRO,   \mkred{-- ASCII Accumulator output}
   accum_xml_out  \kw{is} <| source ++ "-accum_xml.out"|> :: Maybe TextRO,   \mkred{-- XML Accumulator output}
   xml_c          \kw{is} <| source ++ "-xml.c"|>         :: Maybe TextRO,   \mkred{-- Template for XML converter}
   xml_out        \kw{is} <| source ++ "-xml.out"|>       :: Maybe TextRO,   \mkred{-- XML representation of source}
   xml_xsd        \kw{is} <| source ++ ".xsd" |>          :: Maybe TextRO,   \mkred{-- Xschema for XML representation of source}
   fmt_c          \kw{is} <| source ++ "-fmt.c" |>        :: Maybe TextRO,   \mkred{-- Template for formatting program}
   fmt_out        \kw{is} <| source ++ "-fmt.out" |>      :: Maybe TextRO    \mkred{-- Formatted representation of source}
 \}
\mbox{}
\mkred{\{- Directory that stores all information for one user. -\}}
 \kw{type} User_d(arg@ (r, sources) :: (FilePath, [String])) = \kw{Directory} \{
    dataSets    \kw{is} "data"    :: Maybe (Data_d arg),
    runExamples \kw{is}       [ s :: Maybe (Example_d s) | s <- sources]
  \}
\mbox{}
\mkred{\{- Collection of directories containing temporary information for all users. -\}}
 \kw{type} Users_d((r,info) :: (FilePath, Info_d)) = 
    [userDir :: User_d <|(r, getSources info) |>  | userDir <- <| userNames info |> ]
\mbox{}
\end{code}

\begin{code}
\mkred{\{- Top-level of PADS website. -\}}
 \kw{type} Website_d(config::FilePath)  = \kw{Directory} \{
  c               \kw{is} config               :: Config,           \mkred{-- Locations of other components}
  static_content  \kw{is} <| gstatic_dst c  |> :: Static_d,         \mkred{-- Static web site content}
  dynamic_content \kw{is} <| gcgi_dst c     |> :: Cgi_d,            \mkred{-- Dynamic web site content}
  scripts         \kw{is} <| gscript_path c |> :: Scripts_d,        \mkred{-- Shell scripts to run learning system}
  admin_info      \kw{is} <| gstatic_dst c  |> :: Info_d,           \mkred{-- Administrative information about website}
  data_dir        \kw{is} <| (glearn_home c)++"/examples/data" |>
                  :: DataSource_d <|(getSources admin_info)|>, \mkred{-- Stock data files for website}
  usr_data        \kw{is} <| gtmp_root c |>    :: Users_d  <|(get_fullpath data_dir_md, admin_info)|>   
                                                               \mkred{-- User-specific information}
 \}
 
|]
\mbox{}
\mkred{\{- HASKELL HELPER FUNCTIONS -\}}
isReadOnly md = get_modes md == "-rw-r--r--"
\mbox{}
\mkred{\{- Function userName gets the list of user directorn names from an info structure. -\}}
userNames info = getUserEntries (users info)
getUserEntries (UserEntries (UserEntries_f users)) = map userEntryToFileName users
userEntryToFileName userEntry = pairToFileName (dirId userEntry)
pairToFileName (n1, n2) = "id."++(show n1)++"."++(show n2)
\mbox{}
\mkred{\{- Helper functiosn to convert a Config entry to a FileName -\}}
ghost_name   (Config c) = host_name c
gstatic_path (Config c) = static_path c
gcgi_path    (Config c) = cgi_path c
gscript_path (Config c) = script_path c
glearn_home  (Config c) = learn_home c
gtmp_root    (Config c) = tmp_root c
gstatic_dst  (Config c) = static_dst c
gcgi_dst     (Config c) = cgi_dst c


\end{code}