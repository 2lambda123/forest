
\newcommand{\rb}[1]{\raisebox{6ex}[0pt]{#1}}

\begin{figure*}[t]
\[
\begin{array}{lcl}

    {\cal C}\lsem\mathtt{\{ src=} e_{src}; 
 &=& (S, \{((\atime,\loc), \esemantics{e_f\; (\universe'(\loc,\atime))}{\environment}))
          \setalt \atime \in S
          \;\mbox{and}\; \loc \in  \esemantics{e_{src}}{\environment}
     \})
\\
 \quad\ \   \mathtt{sched=} e_{sched};
&&\quad\mbox{where} \\
 \quad\ \  \mathtt{win=} e_{win};
&& \qquad S = \esemantics{e_{sched}}{\environment} \\
 \quad\ \  \mathtt{pp=} e_{pp};
&& 
\qquad \mathtt{timeout} =  
     \lambda (x_t,(x_{at},x_s)).
        \mathtt{if}\, x_{at} \leq x_t + \esemantics{e_{win}}{\environment} \,
        \mathtt{then}\,  x_s \, \mathtt{else} \, \mathtt{None} 
 \\
 \quad\ \  \mathtt{format=} e_{f}; \}\rsem_{{\environment} \, {\universe}}
&& \qquad \universe' =
     \lambda (x_{\ell}, x_t). 
           \esemantics{e_{pp}}{\environment}\, 
                 (\mathtt{timeout}\, (x_t,\universe (x_\ell,x_t))) 
\\\\

\semantics{\mathtt{all}\ \corefeed}{\universe}{\environment} 
&=& 
A\ \ \ \mbox{where}\ (S,A) = \csemantics{C}{\universe}{\environment}
\\\\


%New version: any rule
\semantics{\mathtt{any}\ \corefeed}{\universe}{\environment} 
& = & \{ i_t\ |\ \atime \in S\}\\
&&
\begin{array}{l}
 \begin{array}{ll@{\hspace{1ex}}c@{\hspace{1ex}}l}
 \mbox{where} & (S,A)   & = &\csemantics{C}{\environment}{\universe}\\
              & A_\atime & = & \{(\meta,\some{v})\ | \ (\meta, \some{v}) \in A\ \mbox{and} \ \mytime{\meta} = \atime\}\\
              & i_\atime & = & \left\{ \begin{array}{lll}
                                           \mbox{\selectOne}(A_\atime) & \mbox{if} & |A_\atime| > 0\\
                                           ((\atime,\generatedloc), \none) & \mbox{if} & |A_\atime| = 0 \\
                                           \end{array} \right.\\
 \end{array}
\end{array} 
%%End New version: any rule
\\\\

\semantics{\emptyfeed}{\environment}{\universe} 
 &=& \{\;\}
\\\\
\semantics{\computed{e_1}{x}{e_2}}{\environment}{\universe} 
 &=& \{((\atime,\generatedloc), \esemantics{(\lambda x.e_1) \; \atime}{\environment}) 
          \setalt \atime \in  \esemantics{e_2}{\environment} 
     \} 
\\\\
\semantics{\comprehensionfeed{e}{x}{\feed}}{\environment}{\universe} 
 &=& \{((\mytime{\meta},\generatedloc), \esemantics{(\lambda x.e) \; v}{\environment}) 
          \setalt (\meta,v) \in  \semantics{\feed}{\environment}{\universe}  
     \} 
\\\\
\semantics{\filterfeed{\feed}{e}}{\environment}{\universe} 
 &=&
\{(\meta,v) \setalt (\meta,v) \in \semantics{\feed}{\environment}{\universe} \; \mbox{and} \;
            \esemantics{e \; v}{\environment} = \mathtt{true}
\}
\\\\
\semantics{\letfeed{x}{e_1}{\feed_2}}{\environment}{\universe} 
 &=& \semantics{\feed_2}{(\environment,x\mapsto\esemantics{e_1}{\environment})}{\universe} 
\\\\

\semantics{\feed_1 \unionfeed \feed_2}{\environment}{\universe} 
 &=& \semantics{\feed_1}{\environment}{\universe} 
     \bigcup
     \semantics{\feed_2}{\environment}{\universe} 
\\\\
\semantics{\feed_1 \sumfeed \feed_2}{\environment}{\universe} 
 &=& \{
      ((\mytime{\meta},\inl{\meta}),\inl{v}) \setalt 
        (\meta,v) \in \semantics{\feed_1}{\environment}{\universe} 
     \}
     \bigcup
     \{
      ((\mytime{\meta},\inr{\meta}),\inr{v}) \setalt 
        (\meta,v) \in \semantics{\feed_2}{\environment}{\universe}
     \}
\\\\
\semantics{(\feed_1, \feed_2)}{\environment}{\universe} 
 &=&
 \{((\mytime{\meta_1},(\meta_1,\meta_2)),(v_1,v_2)) \setalt 
     (\meta_1,v_1) \in \semantics{\feed_1}{\environment}{\universe} 
     \; \mbox{and} \; 
     (\meta_2,v_2) \in \semantics{\feed_2}{\environment}{\universe}
     \; \mbox{and} \; 
     \mytime{\meta_1} = \mytime{\meta_2}
  \}
\\\\
% \semantics{\feed_1 * \feed_2}{\environment}{\universe} 
%  &=&
%  \{(\atime_2,(v_1,v_2)) \setalt 
%      (\atime_1,v_1) \in \semantics{\feed_1}{\environment}{\universe} 
%      \; \mbox{and} \; 
% \\&&\qquad\qquad\qquad\ \ \,
%      (\atime_2,v_2) \in \semantics{\feed_2}{\environment}{\universe}
%      \; \mbox{and} \;
% \\&&\qquad\qquad\qquad\ \ \,
%      ((\atime_1',v_1') \in \semantics{\feed_1}{\environment}{\universe} 
%       \; \mbox{implies} \; (t_1' \leq t_1 \; \mbox{or} \; t_1' > t_2)) 
%   \}
% \\\\
\semantics{x{:}\feed_1 * \feed_2}{\environment}{\universe} 
 &=&
 \{(\mytime{\meta_2},(\meta_1,\meta_2)),(v_1,v_2)) \setalt 
     (\meta_1,v_1) \in \semantics{\feed_1}{\environment}{\universe} 
     \; \mbox{and} \; 
\\&&\qquad\qquad\qquad\qquad\qquad\qquad\ \ \,
     (\meta_2,v_2) \in \semantics{\feed_2}{(\environment,x\mapsto{}v_1)}{\universe}
     \; \mbox{and} \; \mytime{\meta_2} > \mytime{\meta_1}
  \}
\\\\
\semantics{x{:}\feed_1 \, {*}{*} \, \feed_2}{\environment}{\universe} 
 &=&
 \{(\mytime{\meta_2},(\meta_1,\meta_2)),(v_1,v_2)) \setalt 
     (\meta_1,v_1) \in \semantics{\feed_1}{\environment}{\universe} 
     \; \mbox{and} \; 
\\&&\qquad\qquad\qquad\qquad\qquad\qquad\ \ \,
     (\meta_2,v_2) \in \semantics{\feed_2}{(\environment,x\mapsto{}v_1)}{\universe}
     \; \mbox{and} \; \mytime{\meta_2} > \mytime{\meta_1}
\\&&\qquad\qquad\qquad\qquad\qquad\qquad\ \ \,
     ((\meta_1',v_1') \in \semantics{\feed_1}{\environment}{\universe} 
      \; \mbox{implies} \; (\mytime{\meta_1'} \leq \mytime{\meta_1} 
            \; \mbox{or} \; \mytime{\meta_1'} > \mytime{\meta_2})) 
  \}
\\\\
%%OLD foreach update
%%{\cal F}\lsem
%%\mathtt{foreach{*}}\; x \; \mathtt{in}\; \feed_1 
%%%\semantics{\foreachupdate{x}{\feed_1}{\feed_2}}{\environment}{\universe} 
%% &=&
%% \{(\meta_2,v_2) \setalt 
%%     (\meta_1,v_1) \in \semantics{\feed_1}{\environment}{\universe} 
%%     \; \mbox{and} \; 
%%\\
%%\qquad\qquad\ \ \mathtt{create}\; \feed_2 \rsem_{{\environment} \, {\universe}}
%%&&\qquad\qquad\ \,
%%     (\meta_2,v_2) \in \semantics{\feed_2}{(\environment,x\mapsto{}v_1)}{\universe}
%%     \; \mbox{and} \;
%%%\\&&\qquad\qquad\ \,
%%     \mytime{\meta_2} > \mytime{\meta_1} 
%%  \}
%%\\\\




%% New foreach *
{\cal F}\lsem
\mathtt{foreach{*}}\; x \; \mathtt{in}\; \feed_1 
%\semantics{\foreachupdate{x}{\feed_1}{\feed_2}}{\environment}{\universe} 
 &=&
   \{(\meta_2,v_2) \setalt (\atime,(\meta_1,\meta_2)),(v_1,v_2)) \in 
       \semantics{x{:}\feed_1 * \feed_2}{\environment}{\universe} \}
%% \{(\meta_2,v_2) \setalt 
%%     (\meta_1,v_1) \in \semantics{\feed_1}{\environment}{\universe} 
%%     \; \mbox{and} \; 
\\
\qquad\qquad\ \ \mathtt{create}\; \feed_2 \rsem_{{\environment} \, {\universe}}
%% End New foreach *
\\\\

%% Old foreach **
%%{\cal F}\lsem
%%\mathtt{foreach{*}{*}}\; x \; \mathtt{in}\; \feed_1 
%%%\semantics{\foreachcreate{x}{\feed_1}{\feed_2}}{\environment}{\universe} 
%% &=&
%% \{(\meta_2,v_2) \setalt 
%%     (\meta_1,v_1) \in \semantics{\feed_1}{\environment}{\universe} 
%%     \; \mbox{and} \; 
%%\\
%%\qquad\qquad\ \ \ \mathtt{update}\; \feed_2 \rsem_{{\environment} \, {\universe}}
%%&&\qquad\qquad\ \,
%%     (\meta_2,v_2) \in \semantics{\feed_2}{(\environment,x\mapsto{}v_1)}{\universe}
%%     \; \mbox{and} \; \mytime{\meta_2} > \mytime{\meta_1} \; \mbox{and} \;
%%\\&&\qquad\qquad\ \,
%%     ((\meta_1',v_1') \in \semantics{\feed_1}{\environment}{\universe} 
%%      \; \mbox{implies} \; (\mytime{\meta_1'} \leq \mytime{\meta_1} 
%%           \; \mbox{or} \; \mytime{\meta_1'} > \mytime{\meta_2}))      
%%  \}
%%\\\\
%% End Old foreach **

%% New Foreach **
{\cal F}\lsem
\mathtt{foreach{*}{*}}\; x \; \mathtt{in}\; \feed_1 
 &=&
   \{(\meta_2,v_2) \setalt (\atime,(\meta_1,\meta_2)),(v_1,v_2)) \in 
       \semantics{x{:}\feed_1\, {**}\, \feed_2}{\environment}{\universe} \}\\
\qquad\qquad\ \ \ \mathtt{update}\; \feed_2 \rsem_{{\environment} \, {\universe}}
\\\\
%% end new foreach **

% \semantics{\ppfeed{\feed}{e}}{\environment}{\universe} 
%  &=&
% \semantics{\feed}{\environment}{
%   (\lambda x{:}\locty * \timety. \esemantics{e}{\environment} (x,\universe(x)))} 
% \\\\
% \semantics{\remapfeed{\feed}{e}}{\environment}{\universe} 
%  &=&
% \semantics{\feed}{\environment}{(\universe \circ \esemantics{e}{\environment})}
% \\\\
%% \semantics{\refeed{\feed}{e}}{\environment}{\universe} 
%%  &=&
%% \{(\atime,\some{v}) \setalt 
%%    (\atime,v) \in \semantics{\feed}{\environment}{\universe} \; \mbox{and} \;
%%    \atime \in \esemantics{e}{\environment}
%% \} \bigcup
%% \\&&
%% \{(\atime,\none) \setalt
%%    (\atime,\_) \not\in \semantics{\feed}{\environment}{\universe} \; \mbox{and} \;
%%    \atime \in \esemantics{e}{\environment}
%% \}
%% \\\\
%% \semantics{\stutterfeed{\feed}{e}}{\environment}{\universe} 
%%  &=&
%% \{(\atime,v) \setalt 
%%    (\atime,v) \in \semantics{\feed}{\environment}{\universe} \; \mbox{and} \;
%%    \atime \in \esemantics{e}{\environment}
%% \} \bigcup
%% \\&&
%% \{(\atime,v) \setalt 
%%    (\atime',v) \in \semantics{\feed}{\environment}{\universe} \; \mbox{and} \;
%%    \atime \in \esemantics{e}{\environment}  \; \mbox{and} \;
%% \\&&\qquad\qquad\qquad\ \ \,
%%     \mbox{for all $\atime''$ such that $\atime' < \atime'' \leq \atime$,} \;
%%    (\atime'',\_) \not\in \semantics{\feed}{\environment}{\universe} \; 
%% \}
\semantics{[\feed \bnfalt x \leftarrow e]}{\environment}{\universe} 
 &=&
 \{((\atime,[\meta_1,\ldots,\meta_k]),[v_1,\ldots,v_k]) \setalt 
    \exists \atime.\forall i:1\ldots k.
     (\meta_i,v_i) \in \semantics{\feed}{\environment[x\mapsto z_i]}{\universe} 
     \; \mbox{and} \; 
     \mytime{\meta_i} =\atime
  \} \\
&&\quad\mbox{where} \quad\mbox{$[z_1,\ldots,z_k] = \esemantics{e}{\environment}$}
\\
\end{array}
\]
\caption{Feed Language Semantics.}
\label{fig:semantics}
\end{figure*}
