\chapter{Popts}
\label{chap:opts}
\Popt{} are used to describe optional data.
The in-memory representation of an option records if the data was
available and if so, the value of that data.  
\section{Syntax}
\label{opts-syntax}
\begin{tabular}{rcl}
\nont{p\_opt\_some}    & \is{}  & \Psome{} identifier \cd{=>} \{ \nont{predicate} \}\\[1ex]
\nont{p\_opt\_none}    & \is{}  & \Pnone{} \cd{=>} \{ \nont{predicate} \}\\[1ex]
\nont{opt\_predicates} & \is{}  & \nont{p\_opt\_some} `$\mid$' \nont{p\_opt\_none} \\
                       & \alt{} & \nont{p\_opt\_none} `$\mid$' \nont{p\_opt\_some} \\
                       & \alt{} & \nont{p\_opt\_none} \\
                       & \alt{} & \nont{p\_opt\_some} \\
\nont{opt\_ty}    & \is{} & \Popt{} \nont{p\_ty} identifier
\opt{\nont{p\_formals}} \opt{: \nont{opt\_predicates}};\\
\\[2ex]

\end{tabular}

\noindent
We explain the meaning of this syntax in the remainder of this chapter.
All non-terminals not defined in this grammar fragment were
defined previously, as follows.
Predicates (\term{predicate}) are defined in \secref{sec:common-predicates},
\padsl{} types (\nont{p\_ty}) and parameter lists (\nont{p\_formals})
in \secref{sec:common-parameterization}. 


\subsection{Examples}
\label{sec:opt-examples}
The following declaration indicates that the type \cd{oPuint32} describes
an optional \cd{Puint32}.  

\input{code/simple-opt}

\noindent
The \pstruct{} \cd{entry1} uses the type \cd{oPuint32} to describe
new-line terminated records with the form:

\begin{verbatim}
12|24
|23
|
24|
\end{verbatim}
\noindent
In this case, the representations of both \cd{f} and \cd{g} will
indicate that the data matched, storing the values \cd{12} and
\cd{24}, respectively.  For the second line, the representation of
\cd{f} will record no match, while \cd{g}'s will indicate a match with
value \cd{23}. 

A slightly more complex example of options uses predicates to
determine if the option matches the input data:
\input{code/constraint-opt}

\noindent
Here, the type \cd{even_t} matches only even \cd{Puint32}s, while
\cd{odd_t} matches only odd \cd{Puint32}s.  The \Psome{} clause binds
the identifier \cd{i} to the in-memory representation of the
\cd{Puint32} found in the data source (if one is found without
error).  With \cd{i} bound, it executes the associated predicate,
which ensures that the number is even for \cd{even_t} and odd for
\cd{odd_t}. 
The type \cd{entry3} uses
these types to describe newline-terminated data of the form:
\begin{verbatim}
12|14|
13|15|
|13|
13|12|
\end{verbatim}
For the first record, \cd{x1} will match \cd{12} and \cd{y1} will
match \cd{14}, while \cd{x2} and \cd{y2} will be marked as not
matching. For the second record, \cd{x2} and \cd{y2} will match 
instead, with \cd{x1} and \cd{y1} being marked as no match, \etc{}


\subsection{Constraints}
\label{sec:opt-constraints}
Option constraints can have a \Psome{} clause and/or a \Pnone{}
clause.  The \Psome{} clause specifies a variable and a predicate to
execute if the base type of the option is successfully read.  If a
legal base element is found, the variable is bound to the in-memory
representation of the base element and the associated predicate is
executed in that context.  If the predicate returns true, the

\subsection{In-line options}
For conciseness, \Popt{}s can be declared in-line in \Pstruct{} and \Punion{}
declarations (\cf{} \secref{sec:structs-inline} and
\secref{sec:unions-inline}).


\section{Generated library}
\label{sec:opts-library}
Currently, \Popt{}s are implemented by translation into \Punion{}
declarations with two branches.  The first branch corresponds to the
case where the value is present in the source. The name of this branch
is \cd{some_OptTy}, where \cd{OptTy} is the name of the \Popt{}
type.  The second branch corresponds to the case where the value is
not present; its name is \cd{none_OptTy}.  For example, the
\pads{} compiler translates the \Popt{} declaration
\input{code/source-opt.tex}
into
\input{code/translation-opt.tex}
and then generates the appropriate code for this declaration.

\subsection{Tags}
\label{sec:opts-tags}
Because the compilation of \Popt{}s is based on that of \Punion{}s,
the \pads{} compiler generates a tag type to describe whether the
option was present.  
\input{code/opt.TyOptTags}
Details about the form of this declaration may be found in
\secref{sec:unions-tags}. 

\subsection{In-memory representation}
\label{sec:opts-rep}
The in-memory representation of an option is a \C{} struct containing
a \cd{tag} field and a \cd{val} field.  The tag indicates whether the
option was present.  If the tag indicates it was, the value field
stores the corresponding value. 
\input{code/opt.TyOptRep}

\subsection{Mask}
\label{sec:opts-masks}
The mask of a \Popt{} is a \C{} struct with two fields.
The first field, called \cd{unionLevel}, allows the programmer to
toggle behavior at the level of the option as a whole.  The second
field controls the behavior of various-library functions on the
``some'' branch of the option, \ie{}, the branch that corresponds to
the value being present in the source.
\input{code/opt.TyOptCSM}

\subsection{Parse descriptor}
\label{sec:opts-parse-descriptors}
The parse descriptor of a \Popt{} is a \C{} struct, with all
the fields described in \secref{sec:common-parse-descriptor}. In
addition,  there is a \cd{tag} field indicating whether the option
appeared in the source and a \cd{val} field which stores
the parse descriptor of the populated branch, represented as a \C{}
union. 
\input{code/opt.TyOptPD}

\subsection{Operations}
\label{sec:opts-operations}
The operations generated by the \pads{} compiler for a \Popt{} are
those described in \chapref{chap:common-features}.  In addition, there
is an extra function that converts a value of the tagtype for the
option to a string.  For a \Popt{} named \cd{OptTy}, this function
has the name \cd{OptTy_tag2str}.  
For the \Punion{}
\cd{OptTy}, the prototypes for all the generated functions appear in
\figref{fig:popt-ops}.
\begin{figure}
\label{fig:popt-ops}
\input{code/opt.TyOptOps}
\caption{Prototypes of operations generated for the \Popt{} \texttt{TyOpt}.}
\end{figure}

\subsubsection{Read function}

The error codes for \Popt{}s are:

\tskip{}
\begin{tabular}{lp{4in}}
 \cd{P_NO_ERR}                 & Indicates no error occurred\\[1ex]
 \cd{P_OPTION_MATCH_ERR}       & Indicates that no branch of the
                                    option parsed without error.\\[1ex]
\end{tabular}

\noindent
For a option parsing function to return the \cd{P_OPTION_MATCH_ERR}, 
the \Popt{} declaration must include a \Pnone{} clause that returns
false.  

\subsubsection{Accumulator functions}
Accumulator functions for \Popt{}s are described in \chapref{chap:accumulators}. 

