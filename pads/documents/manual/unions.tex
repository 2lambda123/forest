\chapter{Punions}
\label{chap:unions}
\Punion{}s are used to express variations in data.  \pads{}
supports two forms of union: switched and in-place.  The first form
supports data sources where there is an indication (\ie, a switch) in
the data prior to the union indicating which alternative should be
chosen.  The second form supports data sources where no such switch is
present.  In this case, the read code tries the branches in order
until it finds one in which no errors occurred during parsing.
\section{Syntax}
\begin{tabular}{rcl}
\nont{union\_field} & \is{} & \nont{full\_field} \alt{} \nont{comp\_field}\\[1ex]
\nont{branch}     & \is{} & \Pcase{} \nont{expression} : \nont{union\_field}
                    \alt{}  \Pdefault : \nont{union\_field}\\[1ex]
\nont{branches}   & \is{} & \nont{branch} \alt{} \nont{branch} \nont{branches} \\[1ex]
\nont{switched}   & \is{} & \Pswitch{} (\nont{expression})\{ \nont{branches} \}\\[1ex]
\nont{in\_place}  & \is{} & \nont{branches}\\[1ex]
\nont{union\_bdy} & \is{} & \nont{switched} \alt{} \nont{in\_place}\\[1ex]
\nont{union\_ty}  & \is{} & \Punion{} identifier \opt{\nont{formals}} \{ \nont{union\_bdy} \} \\[4ex]
\end{tabular}

\noindent
We explain the meaning of this syntax in the remainder of this chapter.
All non-terminals not defined in this grammar fragment were
defined previously, as follows.
Full fields (\nont{full\_field}) 
appear in \secref{sec:structs-full-fields}, 
computed fields (\nont{comp\_field}) in
\secref{sec:structs-computed-fields}, and
parameter lists (\nont{formals}) in \secref{sec:common-parameterization}.
Expressions (\nont{expression}) represent any \C{} expression. 


\subsection{Example: Switched \Punion{}s}
The following description uses a switched \Punion{} to describe data
which starts with an 
integer tag that determines the form of the rest of the data.  A tag
value of \cd{1} indicates an unsigned integer will follow, while a tag
value of \cd{2} indicates a string terminated by an end-of-record
mark.  Any other value for the tag indicates that no further data
exists for the union.   Examples of this data format include:
\begin{verbatim}
 1 4
 2 hello
 3
\end{verbatim}

\input{code/union.switch}
The \Pstruct{} \cd{choice} handles reading the tags

\subsection{Example: In-place \Punion{}s}
\input{code/host_t}
tries each branch in turn til one found that succeeds in finding an
element of the indicated type and satisifies the constraint.


\section{Generated library}
\subsection{In-memory representation}
\label{sec:unions-rep}
\subsection{Mask}
\label{sec:unions-masks}
\subsection{Parse descriptor}
\label{sec:unions-parse-descriptors}
\subsection{Operations}
init/cleanup rep
init/cleanup ed
\subsubsection{read}
  error codes
\subsubsection{Accumulator functions}

